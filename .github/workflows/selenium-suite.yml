name: Run Selenium Tests

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to run tests against'
        required: true
        type: choice
        options:
          - local
          - stage
          - prod
        default: 'stage'
      module:
        description: 'Module to test (select "none" for all modules)'
        required: false
        type: choice
        options:
          - none
          - image
          - video
          - audio
          - all
        default: 'none'
      test_suite:
        description: |
          Leave empty → run all tests
          Single class → ImageGeneratorTests
          Specific method → ImageGeneratorTests#testGenerateImage
          Multiple classes → ClassA,ClassB
        required: false
        default: ""

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17

      - name: Set up Chrome
        uses: browser-actions/setup-chrome@v1

      - name: Run Tests
        env:
          HEADLESS: true
          CI: true
          GITHUB_ACTIONS: true
        run: |
          ENV="${{ github.event.inputs.environment }}"
          MODULE="${{ github.event.inputs.module }}"
          TEST_SUITE="${{ github.event.inputs.test_suite }}"
          
          echo "Environment: $ENV"
          echo "Module: ${MODULE:-all modules}"
          echo "Test Suite: ${TEST_SUITE:-all tests}"
          
          # Build Maven profile flags
          PROFILE_FLAGS="-P$ENV"
          if [ -n "$MODULE" ] && [ "$MODULE" != "none" ]; then
            PROFILE_FLAGS="$PROFILE_FLAGS -P$MODULE"
          fi
          
          # Build Maven command
          if [ -z "$TEST_SUITE" ]; then
            echo "Running all tests for $ENV environment"
            mvn clean test $PROFILE_FLAGS
          else
            echo "Running selected test(s): $TEST_SUITE"
            mvn clean test $PROFILE_FLAGS -Dtest="$TEST_SUITE"
          fi

      - name: Generate Allure Report (for email)
        if: always()
        run: |
          echo "Generating Allure report for email notification..."
          if [ -d "target/allure-results" ]; then
            mvn allure:report || echo "Warning: Allure report generation failed, but continuing..."
          else
            echo "Warning: No Allure results found in target/allure-results"
          fi

      - name: Check Email Configuration
        if: always()
        run: |
          echo "=== Email Configuration Check ==="
          echo "Checking if email is enabled in config..."
          # Email will be sent automatically by AllureReportListener after tests complete
          echo "Email service will be triggered by AllureReportListener"
          echo "Check the test output above for email sending status"


