name: Run Selenium Tests with Allure Reports

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Choose environment'
        required: true
        default: stage
        type: choice
        options:
          - stage
          - prod
      testClass:
        description: |
          Optional: 
          - Leave empty to run all tests from suite XML
          - Single class: com.liftofftech.falcon.tests.image.ImageGeneratorTests
          - Single method: com.liftofftech.falcon.tests.image.ImageGeneratorTests#testGenerateImage
          - Multiple classes: com.liftofftech.falcon.tests.image.ImageGeneratorTests,com.liftofftech.falcon.tests.common.LoginTests
        required: false
        default: ''

jobs:
  run-tests:
    runs-on: ubuntu-latest

    steps:
    # 1️⃣ Checkout repository
    - name: Checkout repository
      uses: actions/checkout@v3

    # 2️⃣ Set up Java
    - name: Set up Java
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'

    # 3️⃣ Clean Maven project
    - name: Clean Maven project
      run: mvn clean

    # 4️⃣ Run Maven tests with optional testClass
    - name: Run Maven tests
      run: |
        TEST_CLASS_ARG=""
        if [ ! -z "${{ github.event.inputs.testClass }}" ]; then
          TEST_CLASS_ARG="-Dtest=$(echo ${{ github.event.inputs.testClass }} | tr ',' '+')"
        fi

        if [ "${{ github.event.inputs.environment }}" == "stage" ]; then
          CONFIG_ARG="-Dconfig.file=property.stage.config"
          echo "Running tests in STAGE environment..."
        else
          CONFIG_ARG="-Dconfig.file=property.prod.config"
          echo "Running tests in PROD environment..."
        fi

        # Run Maven tests and generate Allure results
        mvn clean test $CONFIG_ARG $TEST_CLASS_ARG

    # 5️⃣ Generate Allure report
    - name: Generate Allure report
      run: |
        mvn allure:report

    # 6️⃣ Upload Allure report
    - name: Upload Allure Report
      uses: actions/upload-artifact@v4
      with:
        name: allure-report
        path: target/site/allure-maven-plugin
