name: Run Selenium Tests on Cloud

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Choose environment'
        required: true
        default: stage
        type: choice
        options:
          - stage
          - prod
      testClass:
        description: |
          Optional: 
          - Leave empty to run all tests from suite XML
          - Single class: com.liftofftech.falcon.tests.image.ImageGeneratorTests
          - Single method: com.liftofftech.falcon.tests.image.ImageGeneratorTests#testGenerateImage
          - Multiple classes: com.liftofftech.falcon.tests.image.ImageGeneratorTests,com.liftofftech.falcon.tests.common.LoginTests
        required: false
        default: ''

jobs:
  run-tests:
    runs-on: ubuntu-latest

    steps:
    # 1️⃣ Checkout repository
    - name: Checkout repository
      uses: actions/checkout@v3

    # 2️⃣ Set up Java
    - name: Set up Java
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'

    # 3️⃣ Clean Maven project
    - name: Clean Maven project
      run: mvn clean

    # 4️⃣ Run Maven tests dynamically
    - name: Run Maven tests
      run: |
        # Prepare -Dtest argument
        TEST_CLASS_ARG=""
        if [ ! -z "${{ github.event.inputs.testClass }}" ]; then
          # Replace commas with + for multiple classes
          TEST_CLASS_ARG="-Dtest=$(echo ${{ github.event.inputs.testClass }} | tr ',' '+')"
        fi

        # Select environment config
        if [ "${{ github.event.inputs.environment }}" == "stage" ]; then
          CONFIG_ARG="-Dconfig.file=property.stage.config"
          echo "Running tests in STAGE environment..."
        else
          CONFIG_ARG="-Dconfig.file=property.prod.config"
          echo "Running tests in PROD environment..."
        fi

        # Run Maven with optional -Dtest
        mvn test -U $CONFIG_ARG $TEST_CLASS_ARG

    # 5️⃣ Upload Surefire reports for debugging
    - name: Upload Surefire reports
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: surefire-reports
        path: target/surefire-reports/
